<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœ¬åœ°é‡åŒ–é€‰è‚¡å¹³å°</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        h1 {
            text-align: center;
            color: #333;
        }

        .tab-container {
            margin-bottom: 20px;
        }

        .tab-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .tab-button {
            padding: 10px 20px;
            background-color: #e9ecef;
            border: 1px solid #ddd;
            cursor: pointer;
            border-radius: 5px 5px 0 0;
        }

        .tab-button.active {
            background-color: #007bff;
            color: white;
        }

        .tab-content {
            display: none;
            padding: 20px;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 5px 5px;
        }

        .tab-content.active {
            display: block;
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 5px;
        }

        .control-group {
            flex: 1;
            min-width: 200px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        input,
        select,
        button {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }

        button {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            cursor: pointer;
            font-size: 16px;
        }

        button:hover {
            background-color: #0056b3;
        }

        .results {
            margin-top: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        th,
        td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th {
            background-color: #f2f2f2;
            font-weight: bold;
        }

        tr:hover {
            background-color: #f5f5f5;
        }

        .chart-container {
            height: 400px;
            margin-top: 20px;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .backtest-summary {
            background: #e7f3ff;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        .summary-item {
            display: inline-block;
            margin-right: 30px;
            font-weight: bold;
        }

        .trade-type-buy {
            color: red;
        }

        .trade-type-sell {
            color: green;
        }

        .trade-profit-positive {
            color: red;
        }

        .trade-profit-negative {
            color: green;
        }
        
        .data-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
            padding: 20px;
            background: #e8f4f8;
            border-radius: 5px;
        }
        
        .status-display {
            background: #d4edda;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>æœ¬åœ°é‡åŒ–é€‰è‚¡å¹³å°</h1>

        <div class="tab-container">
            <div class="tab-buttons">
                <div class="tab-button active" onclick="switchTab('data')">æ•°æ®ç®¡ç†</div>
                <div class="tab-button" onclick="switchTab('screener')">è‚¡ç¥¨ç­›é€‰</div>
                <div class="tab-button" onclick="switchTab('backtest')">ç­–ç•¥å›æµ‹</div>
            </div>

            <div id="data-tab" class="tab-content">
                <h2>æ•°æ®ç®¡ç†</h2>
                
                <div class="data-controls">
                    <div class="control-group">
                        <label>æ•°æ®çŠ¶æ€:</label>
                        <div id="data-status" class="status-display">ç‚¹å‡»"åˆ·æ–°çŠ¶æ€"è·å–æ•°æ®ä¿¡æ¯</div>
                    </div>
                    <div class="control-group">
                        <button onclick="refreshDataStatus()">ğŸ”„ åˆ·æ–°çŠ¶æ€</button>
                    </div>
                    <div class="control-group">
                        <button onclick="updateTodayData()" style="background-color: #28a745;">ğŸ“ˆ å¢é‡æ›´æ–°ä»Šæ—¥æ•°æ®</button>
                    </div>
                    <div class="control-group">
                        <button onclick="generateStockPool()" style="background-color: #ffc107; color: #212529;">ğŸ“Š ç”Ÿæˆè‚¡ç¥¨æ± </button>
                    </div>
                    <div class="control-group">
                        <button onclick="repairMissingData()" style="background-color: #dc3545; color: white;">ğŸ”§ ä¿®å¤ç¼ºå¤±æ•°æ®</button>
                    </div>
                </div>

                <div id="data-loading" class="loading" style="display: none;">
                    æ­£åœ¨å¤„ç†æ•°æ®ï¼Œè¯·ç¨å€™...
                </div>
            </div>

            <div id="screener-tab" class="tab-content">
                <div class="controls">
                    <div class="control-group">
                        <label for="screener_date">é€‰è‚¡æ—¥æœŸ:</label>
                        <input type="date" id="screener_date" value="2025-12-01">
                    </div>
                    <div class="control-group">
                        <label for="min_price">æœ€ä½ä»·æ ¼:</label>
                        <input type="number" id="min_price" value="0" step="0.01">
                    </div>
                    <div class="control-group">
                        <label for="max_price">æœ€é«˜ä»·æ ¼:</label>
                        <input type="number" id="max_price" value="9999" step="0.01">
                    </div>
                    <div class="control-group">
                        <label for="strategy">é€‰è‚¡ç­–ç•¥:</label>
                        <select id="strategy">
                            <option value="verified" selected>âœ… éªŒè¯ç­–ç•¥ (Hybrid: å®æ—¶/å›æµ‹)</option>
                            <option value="all">å…¨éƒ¨</option>
                            <option value="high_open">é¦–æ¿é«˜å¼€ (æ—§ç‰ˆ)</option>
                            <option value="low_open">é¦–æ¿ä½å¼€ (æ—§ç‰ˆ)</option>
                            <option value="weak_to_strong">å¼±åŠ¿è½¬å¼ºåŠ¿ (æ—§ç‰ˆ)</option>
                            <option value="mixed">æ··åˆç­–ç•¥ (æ—§ç‰ˆ)</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <button onclick="screenStocks()">å¼€å§‹é€‰è‚¡</button>
                    </div>
                    <div class="control-group">
                        <button onclick="fastScreenStocks()" style="background-color: #28a745;">ğŸš€ å¿«é€Ÿé€‰è‚¡</button>
                    </div>
                </div>

                <div id="screener-loading" class="loading" style="display: none;">
                    æ­£åœ¨ç­›é€‰è‚¡ç¥¨ï¼Œè¯·ç¨å€™...
                </div>

                <div class="results">
                    <h3>é€‰è‚¡ç»“æœ</h3>
                    <div id="results-count"></div>
                    <table id="results-table">
                        <thead>
                            <tr>
                                <th>è‚¡ç¥¨ä»£ç </th>
                                <th>è‚¡ç¥¨åç§°</th>
                                <th>å½“å‰ä»·æ ¼</th>
                                <th>é€‰è‚¡ç­–ç•¥</th>
                                <th>æ€§èƒ½</th>
                            </tr>
                        </thead>
                        <tbody id="results-body">
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="backtest-tab" class="tab-content">
                <div class="controls">
                    <div class="control-group">
                        <label for="backtest_start_date">å¼€å§‹æ—¥æœŸ:</label>
                        <input type="date" id="backtest_start_date" value="2025-01-01">
                    </div>
                    <div class="control-group">
                        <label for="backtest_end_date">ç»“æŸæ—¥æœŸ:</label>
                        <input type="date" id="backtest_end_date" value="2025-12-31">
                    </div>
                    <div class="control-group">
                        <label for="backtest_strategy">å›æµ‹ç­–ç•¥:</label>
                        <select id="backtest_strategy">
                            <option value="verified" selected>âœ… éªŒè¯ç­–ç•¥ (Hybrid: å®æ—¶/å›æµ‹)</option>
                            <option value="mixed">æ··åˆç­–ç•¥ï¼ˆæ—§ç‰ˆï¼‰</option>
                            <option value="high_open">é¦–æ¿é«˜å¼€ï¼ˆæ—§ç‰ˆï¼‰</option>
                            <option value="low_open">é¦–æ¿ä½å¼€ï¼ˆæ—§ç‰ˆï¼‰</option>
                            <option value="weak_to_strong">å¼±åŠ¿è½¬å¼ºåŠ¿ï¼ˆæ—§ç‰ˆï¼‰</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label for="initial_capital">åˆå§‹èµ„é‡‘:</label>
                        <input type="number" id="initial_capital" value="100000" step="1000">
                    </div>
                    <div class="control-group">
                        <button onclick="runBacktest()">å¼€å§‹å›æµ‹</button>
                    </div>
                </div>

                <div id="backtest-loading" class="loading" style="display: none;">
                    æ­£åœ¨è¿›è¡Œå›æµ‹ï¼Œè¯·ç¨å€™...
                </div>

                <div id="backtest-results" style="display: none;">
                    <div class="backtest-summary">
                        <div class="summary-item">åˆå§‹èµ„é‡‘: <span id="initial-capital-value"></span></div>
                        <div class="summary-item">æœ€ç»ˆä»·å€¼: <span id="final-value"></span></div>
                        <div class="summary-item">æ€»æ”¶ç›Šç‡: <span id="total-return"></span>%</div>
                    </div>

                    <h3>äº¤æ˜“è®°å½•</h3>
                    <table id="trades-table">
                        <thead>
                            <tr>
                                <th>æ—¥æœŸ</th>
                                <th>è‚¡ç¥¨ä»£ç </th>
                                <th>è‚¡ç¥¨åç§°</th>
                                <th>æ“ä½œ</th>
                                <th>ä»·æ ¼</th>
                                <th>è‚¡æ•°</th>
                                <th>é‡‘é¢</th>
                                <th>ç­–ç•¥/åŸå› </th>
                                <th>ç›ˆäº</th>
                                <th>ç›ˆäº%</th>
                            </tr>
                        </thead>
                        <tbody id="trades-body">
                        </tbody>
                    </table>

                    <h3>èµ„äº§å˜åŒ–æ›²çº¿</h3>
                    <div class="chart-container">
                        <canvas id="portfolio-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // åˆ‡æ¢æ ‡ç­¾é¡µ
        function switchTab(tabName) {
            // éšè—æ‰€æœ‰æ ‡ç­¾å†…å®¹
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            // å–æ¶ˆæ¿€æ´»æ‰€æœ‰æŒ‰é’®
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });

            // æ¿€æ´»é€‰ä¸­çš„æ ‡ç­¾
            document.getElementById(tabName + '-tab').classList.add('active');
            event.target.classList.add('active');
        }

        // è·å–æ•°æ®çŠ¶æ€
        async function refreshDataStatus() {
            const statusDiv = document.getElementById('data-status');
            const loading = document.getElementById('data-loading');
            
            loading.style.display = 'block';
            statusDiv.textContent = 'æ­£åœ¨è·å–æ•°æ®çŠ¶æ€...';

            try {
                const response = await fetch('/api/data_status');
                const data = await response.json();

                if (data.status === 'success') {
                    statusDiv.innerHTML = `
                        <strong>ğŸ“Š æ•°æ®çŠ¶æ€:</strong> ${data.message}<br>
                        <strong>ğŸ“… æœ€æ–°æ—¥æœŸ:</strong> ${data.latest_date}<br>
                        <strong>ğŸ“ˆ è‚¡ç¥¨æ•°é‡:</strong> ${data.total_stocks} åª
                    `;
                } else {
                    statusDiv.textContent = `âŒ è·å–æ•°æ®çŠ¶æ€å¤±è´¥: ${data.message}`;
                }
            } catch (error) {
                statusDiv.textContent = `âŒ è·å–æ•°æ®çŠ¶æ€æ—¶å‡ºé”™: ${error.message}`;
            } finally {
                loading.style.display = 'none';
            }
        }

        // å¢é‡æ›´æ–°ä»Šæ—¥æ•°æ®
        async function updateTodayData() {
            const statusDiv = document.getElementById('data-status');
            const loading = document.getElementById('data-loading');
            
            loading.style.display = 'block';
            statusDiv.innerHTML = '<strong>ğŸ”„ æ­£åœ¨å¢é‡æ›´æ–°ä»Šæ—¥æ•°æ®ï¼Œè¯·ç¨å€™...</strong>';

            try {
                const response = await fetch('/api/update_today_data', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({})
                });
                const data = await response.json();

                if (data.status === 'success') {
                    statusDiv.innerHTML = `
                        <strong>âœ… ${data.message}</strong><br>
                        æˆåŠŸæ›´æ–°: ${data.success_count} åªè‚¡ç¥¨<br>
                        æ›´æ–°å¤±è´¥: ${data.fail_count} åªè‚¡ç¥¨
                    `;
                } else {
                    statusDiv.innerHTML = `<strong>âŒ æ›´æ–°å¤±è´¥:</strong> ${data.message}`;
                }
            } catch (error) {
                statusDiv.innerHTML = `<strong>âŒ æ›´æ–°æ•°æ®æ—¶å‡ºé”™:</strong> ${error.message}`;
            } finally {
                loading.style.display = 'none';
            }
        }

        // ç”Ÿæˆè‚¡ç¥¨æ± 
        async function generateStockPool() {
            const statusDiv = document.getElementById('data-status');
            const loading = document.getElementById('data-loading');
            
            const today = new Date().toISOString().split('T')[0];
            
            loading.style.display = 'block';
            statusDiv.innerHTML = '<strong>ğŸ”„ æ­£åœ¨ç”Ÿæˆè‚¡ç¥¨æ± ï¼Œè¯·ç¨å€™...</strong>';

            try {
                const response = await fetch('/api/generate_stock_pool', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ date: today })
                });
                const data = await response.json();

                if (data.status === 'success') {
                    const poolData = data.pool_data;
                    statusDiv.innerHTML = `
                        <strong>âœ… è‚¡ç¥¨æ± ç”ŸæˆæˆåŠŸ!</strong><br>
                        ç›®æ ‡æ—¥æœŸ: ${poolData.target_date}<br>
                        å‰ä¸€äº¤æ˜“æ—¥: ${poolData.prev_trading_date}<br>
                        å‰å‰äº¤æ˜“æ—¥: ${poolData.prev_2_trading_date}<br>
                        å‰ä¸€æ—¥æ¶¨åœè‚¡ç¥¨æ•°: ${poolData.limit_up_stocks.length}<br>
                        é¦–æ¿è‚¡ç¥¨æ•°: ${poolData.first_board_stocks.length}<br>
                        ç”Ÿæˆæ—¶é—´: ${poolData.generated_at}
                    `;
                } else {
                    statusDiv.innerHTML = `<strong>âŒ ç”Ÿæˆè‚¡ç¥¨æ± å¤±è´¥:</strong> ${data.message}`;
                }
            } catch (error) {
                statusDiv.innerHTML = `<strong>âŒ ç”Ÿæˆè‚¡ç¥¨æ± æ—¶å‡ºé”™:</strong> ${error.message}`;
            } finally {
                loading.style.display = 'none';
            }
        }

        // ä¿®å¤ç¼ºå¤±æ•°æ®
        async function repairMissingData() {
            const statusDiv = document.getElementById('data-status');
            const loading = document.getElementById('data-loading');
            
            if (!confirm('ç¡®å®šè¦ä¿®å¤æ‰€æœ‰ç¼ºå¤±çš„è‚¡ç¥¨æ•°æ®å—ï¼Ÿè¿™å¯èƒ½éœ€è¦ä¸€äº›æ—¶é—´ã€‚')) {
                return;
            }
            
            loading.style.display = 'block';
            statusDiv.innerHTML = '<strong>ğŸ”„ æ­£åœ¨ä¿®å¤ç¼ºå¤±æ•°æ®ï¼Œè¯·ç¨å€™...</strong><br>æ­¤è¿‡ç¨‹å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿæ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…ã€‚';

            try {
                const response = await fetch('/api/repair_missing_data', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({})
                });
                const data = await response.json();

                if (data.status === 'success') {
                    statusDiv.innerHTML = `
                        <strong>âœ… æ•°æ®ä¿®å¤å®Œæˆ!</strong><br>
                        ${data.message}<br>
                        ä¿®å¤è‚¡ç¥¨æ•°: ${data.repaired_count}<br>
                        å¤„ç†æ€»æ•°: ${data.total_processed}
                    `;
                } else {
                    statusDiv.innerHTML = `<strong>âŒ æ•°æ®ä¿®å¤å¤±è´¥:</strong> ${data.message}`;
                }
            } catch (error) {
                statusDiv.innerHTML = `<strong>âŒ ä¿®å¤æ•°æ®æ—¶å‡ºé”™:</strong> ${error.message}`;
            } finally {
                loading.style.display = 'none';
            }
        }

        async function screenStocks() {
            const screenerDate = document.getElementById('screener_date').value;
            const minPrice = parseFloat(document.getElementById('min_price').value) || 0;
            const maxPrice = parseFloat(document.getElementById('max_price').value) || 9999;
            const strategy = document.getElementById('strategy').value;

            const loading = document.getElementById('screener-loading');
            const resultsBody = document.getElementById('results-body');
            const resultsCount = document.getElementById('results-count');

            loading.style.display = 'block';
            resultsBody.innerHTML = '';
            resultsCount.textContent = '';

            try {
                let url = '/api/screen_stocks';
                let body = {
                    date: screenerDate,
                    min_price: minPrice,
                    max_price: maxPrice,
                    strategy: strategy
                };

                // Use verified strategy endpoint if selected
                if (strategy === 'verified') {
                    url = '/api/run_verified_strategy';
                    body = { date: screenerDate };
                }

                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(body)
                });

                const data = await response.json();

                if (data.error) {
                    throw new Error(data.error);
                }

                resultsCount.textContent = `æ‰¾åˆ° ${data.length} åªç¬¦åˆæ¡ä»¶çš„è‚¡ç¥¨`;

                data.forEach(stock => {
                    const row = document.createElement('tr');
                    // ä¿®å¤toFixedé”™è¯¯ï¼Œç¡®ä¿ä»·æ ¼æ˜¯æ•°å­—
                    const price = stock.price !== undefined ? parseFloat(stock.price) : 0;
                    const displayPrice = !isNaN(price) && price > 0 ? price.toFixed(2) : 'N/A';
                    row.innerHTML = `
                        <td>${stock.code}</td>
                        <td>${stock.name}</td>
                        <td>${displayPrice}</td>
                        <td>${stock.strategy}</td>
                        <td>-</td>
                    `;
                    resultsBody.appendChild(row);
                });
            } catch (error) {
                console.error('é€‰è‚¡å‡ºé”™:', error);
                resultsCount.textContent = `é€‰è‚¡å‡ºé”™: ${error.message}`;
            } finally {
                loading.style.display = 'none';
            }
        }

        async function fastScreenStocks() {
            const screenerDate = document.getElementById('screener_date').value;

            const loading = document.getElementById('screener-loading');
            const resultsBody = document.getElementById('results-body');
            const resultsCount = document.getElementById('results-count');

            loading.style.display = 'block';
            resultsBody.innerHTML = '';
            resultsCount.textContent = '';

            try {
                const response = await fetch('/api/fast_screen_stocks', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        date: screenerDate
                    })
                });

                const data = await response.json();

                if (data.error) {
                    throw new Error(data.error);
                }

                // æ˜¾ç¤ºæ±‡æ€»ä¿¡æ¯
                const summary = data.summary || {};
                resultsCount.textContent = `å¿«é€Ÿé€‰è‚¡å®Œæˆï¼å…±é€‰å‡º ${summary.total_selected} åªè‚¡ç¥¨ (é¦–æ¿é«˜å¼€: ${summary.sbgk_count}, é¦–æ¿ä½å¼€: ${summary.sbdk_count}, å¼±è½¬å¼º: ${summary.rzq_count}), è€—æ—¶: ${summary.execution_time.toFixed(2)}ç§’`;

                // æ˜¾ç¤ºè‚¡ç¥¨ç»“æœ
                (data.stocks || []).forEach(stock => {
                    const row = document.createElement('tr');
                    const price = stock.price !== undefined ? parseFloat(stock.price) : 0;
                    const displayPrice = !isNaN(price) && price > 0 ? price.toFixed(2) : 'N/A';
                    row.innerHTML = `
                        <td>${stock.code}</td>
                        <td>${stock.name}</td>
                        <td>${displayPrice}</td>
                        <td>${stock.strategy}</td>
                        <td>${stock.performance || '-'}</td>
                    `;
                    resultsBody.appendChild(row);
                });
            } catch (error) {
                console.error('å¿«é€Ÿé€‰è‚¡å‡ºé”™:', error);
                resultsCount.textContent = `å¿«é€Ÿé€‰è‚¡å‡ºé”™: ${error.message}`;
            } finally {
                loading.style.display = 'none';
            }
        }

        async function runBacktest() {
            const startDate = document.getElementById('backtest_start_date').value;
            const endDate = document.getElementById('backtest_end_date').value;
            const strategy = document.getElementById('backtest_strategy').value;
            const initialCapital = document.getElementById('initial_capital').value;

            const loading = document.getElementById('backtest-loading');
            const resultsDiv = document.getElementById('backtest-results');
            const tradesBody = document.getElementById('trades-body');

            loading.style.display = 'block';
            resultsDiv.style.display = 'none';
            tradesBody.innerHTML = '';

            try {
                const response = await fetch('/api/backtest', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        start_date: startDate,
                        end_date: endDate,
                        strategy: strategy,
                        initial_capital: initialCapital
                    })
                });

                const data = await response.json();

                if (data.error) {
                    throw new Error(data.error);
                }

                // æ˜¾ç¤ºå›æµ‹ç»“æœæ‘˜è¦
                document.getElementById('initial-capital-value').textContent = parseFloat(data.initial_capital).toLocaleString();
                document.getElementById('final-value').textContent = parseFloat(data.final_value).toLocaleString();
                document.getElementById('total-return').textContent = parseFloat(data.total_return).toFixed(2);

                // æ˜¾ç¤ºäº¤æ˜“è®°å½•
                data.trades.forEach(trade => {
                    const row = document.createElement('tr');
                    const tradeTypeClass = trade.type === 'buy' ? 'trade-type-buy' : 'trade-type-sell';
                    const profitClass = trade.profit ? (trade.profit >= 0 ? 'trade-profit-positive' : 'trade-profit-negative') : '';

                    // ä¿®å¤toFixedé”™è¯¯ï¼Œç¡®ä¿æ•°å€¼æ˜¯æ•°å­—
                    const price = !isNaN(parseFloat(trade.price)) ? parseFloat(trade.price).toFixed(2) : 'N/A';
                    const amount = !isNaN(parseFloat(trade.amount)) ? parseFloat(trade.amount).toFixed(2) : 'N/A';
                    const shares = trade.shares || 0;

                    let profitDisplay = 'â€”';
                    let profitRatioDisplay = 'â€”';
                    if (typeof trade.profit !== 'undefined' && !isNaN(parseFloat(trade.profit))) {
                        profitDisplay = parseFloat(trade.profit).toFixed(2);
                    }
                    if (typeof trade.profit_ratio !== 'undefined' && !isNaN(parseFloat(trade.profit_ratio))) {
                        profitRatioDisplay = parseFloat(trade.profit_ratio).toFixed(2) + '%';
                    }

                    row.innerHTML = `
                        <td>${trade.date}</td>
                        <td>${trade.code}</td>
                        <td>${trade.name}</td>
                        <td class="${tradeTypeClass}">${trade.type === 'buy' ? 'ä¹°å…¥' : 'å–å‡º'}</td>
                        <td>${price}</td>
                        <td>${shares}</td>
                        <td>${amount}</td>
                        <td>${trade.strategy}</td>
                        <td class="${profitClass}">${profitDisplay}</td>
                        <td class="${profitClass}">${profitRatioDisplay}</td>
                    `;
                    tradesBody.appendChild(row);
                });

                // æ˜¾ç¤ºèµ„äº§å˜åŒ–å›¾è¡¨
                if (data.portfolio_values && data.portfolio_values.length > 0) {
                    const dates = data.portfolio_values.map(item => item.date);
                    const values = data.portfolio_values.map(item => parseFloat(item.value));

                    const ctx = document.getElementById('portfolio-chart').getContext('2d');
                    if (window.portfolioChart) {
                        window.portfolioChart.destroy();
                    }
                    window.portfolioChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: dates,
                            datasets: [{
                                label: 'èµ„äº§ä»·å€¼',
                                data: values,
                                borderColor: 'rgb(75, 192, 192)',
                                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                                tension: 0.1
                            }]
                        },
                        options: {
                            responsive: true,
                            scales: {
                                y: {
                                    beginAtZero: false
                                }
                            }
                        }
                    });
                }

                resultsDiv.style.display = 'block';
            } catch (error) {
                console.error('å›æµ‹å‡ºé”™:', error);
                alert(`å›æµ‹å‡ºé”™: ${error.message}`);
            } finally {
                loading.style.display = 'none';
            }
        }

        // é¡µé¢åŠ è½½æ—¶è®¾ç½®é»˜è®¤æ—¥æœŸ
        document.addEventListener('DOMContentLoaded', function () {
            // è®¾ç½®é»˜è®¤æ—¥æœŸä¸ºä»Šå¤©
            const today = new Date().toISOString().split('T')[0];
            const oneYearAgo = new Date();
            oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1);
            const oneYearAgoStr = oneYearAgo.toISOString().split('T')[0];

            document.getElementById('screener_date').value = today;
            document.getElementById('backtest_start_date').value = oneYearAgoStr;
            document.getElementById('backtest_end_date').value = today;
            
            // é»˜è®¤æ˜¾ç¤ºæ•°æ®ç®¡ç†æ ‡ç­¾
            switchTab('data');
        });
    </script>
</body>

</html>